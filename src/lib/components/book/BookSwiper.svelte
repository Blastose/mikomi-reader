<script lang="ts">
	export let gapSize: 'default' | 'large' = 'default';

	let scroll = false;
	const useSwipe = (node: HTMLDivElement) => {
		let pointerStartX: number;
		let pointerCurrentX: number;
		let scrollLeftStart: number = 0;
		let moving: boolean = false;
		let velocityX: number;

		const pointerStart = (e: PointerEvent) => {
			if (e.button !== 0) return;
			cancelAnimationFrame(decelerationId);
			pointerStartX = e.x;
			moving = true;
		};

		const pointerEnd = (_: PointerEvent) => {
			if (moving === true) {
				moving = false;
				scrollLeftStart = node.scrollLeft;
				scroll = false;
			}
			beginDeceleration();
		};

		const pointerMove = (e: PointerEvent) => {
			pointerCurrentX = e.x;
			if (moving) {
				scroll = true;
				let diff = pointerCurrentX - pointerStartX;
				const prevScrollLeft = node.scrollLeft;
				node.scrollLeft = scrollLeftStart - diff;
				velocityX = node.scrollLeft - prevScrollLeft;
			}
		};

		let decelerationId: number;
		const beginDeceleration = () => {
			cancelAnimationFrame(decelerationId);
			decelerationId = requestAnimationFrame(decelerationLoop);
		};

		const decelerationLoop = () => {
			node.scrollLeft += velocityX;
			scrollLeftStart = node.scrollLeft;
			velocityX *= 0.95;
			if (Math.abs(velocityX) > 0.5) {
				decelerationId = requestAnimationFrame(decelerationLoop);
			}
		};

		node.addEventListener('pointerdown', pointerStart);
		window.addEventListener('pointerup', pointerEnd);
		window.addEventListener('pointermove', pointerMove);

		return {
			destroy() {
				node.removeEventListener('pointerdown', pointerStart);
				window.removeEventListener('pointerup', pointerEnd);
				window.removeEventListener('pointermove', pointerMove);
			}
		};
	};
</script>

<div class="grid">
	<div class="swipe-container" class:gap-large={gapSize === 'large'} use:useSwipe>
		<slot {scroll} />
	</div>
</div>

<style>
	.swipe-container {
		display: flex;
		gap: 0.5rem;
		user-select: none;
		overflow-x: hidden;
		touch-action: none;
	}

	.swipe-container.gap-large {
		gap: 1.5rem;
	}
</style>
